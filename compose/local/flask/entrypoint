#!/bin/bash

# if any of the commands in your code fails for any reason, the entire script fails
set -o errexit
# fail exit if one of your pipe command fails
set -o pipefail
# exits if any of your variables is not set
set -o nounset

mysql_ready() {
python << END
import sys

import pymysql
import psycopg2
import os

db_type = os.getenv('DATABASE_TYPE')

if db_type == 'mysql':
    try:
        pymysql.connect(
            database='league_manager',
            user=os.getenv('MYSQL_USER'),
            password=os.getenv('MYSQL_PASS'),
            host=os.getenv('MYSQL_HOST'),
            port=int(os.getenv('MYSQL_PORT'))
        )
    except pymysql.OperationalError:
        sys.exit(-1)
    sys.exit(0)
else:
    try:
        psycopg2.connect(
            dbname='league_manager',
            user=os.getenv('POSTGRES_USER'),
            password=os.getenv('POSTGRES_PASS'),
            host=os.getenv('POSTGRES_HOST'),
            port=os.getenv('POSTGRES_PORT')
        )
    except psycopg2.OperationalError:
        sys.exit(-1)
    sys.exit(0)

END
}
until mysql_ready; do
  >&2 echo 'Waiting for Database to become available...'
  sleep 1
done
>&2 echo 'Database is available'

exec "$@"